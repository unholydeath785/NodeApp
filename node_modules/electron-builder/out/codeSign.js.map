{"version":3,"file":"codeSign.js","sourceRoot":"","sources":["../src/codeSign.ts"],"names":[],"mappings":"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","sourcesContent":["import { exec } from \"./util\"\nimport { deleteFile } from \"./promisifed-fs\"\nimport { download } from \"./httpRequest\"\nimport { tmpdir } from \"os\"\nimport * as path from \"path\"\nimport { executeFinally, all } from \"./promise\"\nimport { Promise as BluebirdPromise } from \"bluebird\"\nimport { randomBytes } from \"crypto\"\nimport { tsAwaiter } from \"./awaiter\"\n\nconst __awaiter = tsAwaiter\nArray.isArray(__awaiter)\n\nexport interface CodeSigningInfo {\n  cscName: string\n  cscKeychainName?: string\n}\n\nfunction randomString(): string {\n  return randomBytes(8).toString(\"hex\")\n}\n\nexport function generateKeychainName(): string {\n  return \"csc-\" + randomString() + \".keychain\"\n}\n\nexport function createKeychain(keychainName: string, cscLink: string, cscKeyPassword: string): Promise<CodeSigningInfo> {\n  const appleCertPath = path.join(tmpdir(), randomString() + \".cer\")\n  const developerCertPath = path.join(tmpdir(), randomString() + \".p12\")\n\n  const keychainPassword = randomString()\n  return executeFinally(Promise.all([\n      download(\"https://developer.apple.com/certificationauthority/AppleWWDRCA.cer\", appleCertPath),\n      download(cscLink, developerCertPath),\n      BluebirdPromise.mapSeries([\n        [\"create-keychain\", \"-p\", keychainPassword, keychainName],\n        [\"unlock-keychain\", \"-p\", keychainPassword, keychainName],\n        [\"set-keychain-settings\", \"-t\", \"3600\", \"-u\", keychainName]\n      ], it => exec(\"security\", it))\n    ])\n    .then(() => importCerts(keychainName, appleCertPath, developerCertPath, cscKeyPassword)),\n    error => {\n      const tasks = [deleteFile(appleCertPath, true), deleteFile(developerCertPath, true)]\n      if (error != null) {\n        tasks.push(deleteKeychain(keychainName))\n      }\n      return all(tasks)\n    })\n}\n\nasync function importCerts(keychainName: string, appleCertPath: string, developerCertPath: string, cscKeyPassword: string): Promise<CodeSigningInfo> {\n  await exec(\"security\", [\"import\", appleCertPath, \"-k\", keychainName, \"-T\", \"/usr/bin/codesign\"])\n  await exec(\"security\", [\"import\", developerCertPath, \"-k\", keychainName, \"-T\", \"/usr/bin/codesign\", \"-P\", cscKeyPassword])\n  let cscName = await extractCommonName(cscKeyPassword, developerCertPath)\n  return {\n    cscName: cscName,\n    cscKeychainName: keychainName\n  }\n}\n\nfunction extractCommonName(password: string, certPath: string): BluebirdPromise<string> {\n  return exec(\"openssl\", [\"pkcs12\", \"-nokeys\", \"-nodes\", \"-passin\", \"pass:\" + password, \"-nomacver\", \"-clcerts\", \"-in\", certPath])\n    .then(result => {\n      const match = result[0].toString().match(/^subject.*\\/CN=([^\\/]+)/m)\n      if (match == null || match[1] == null) {\n        throw new Error(\"Cannot extract common name from p12\")\n      }\n      else {\n        return match[1]\n      }\n    })\n}\n\nexport function sign(path: string, options: CodeSigningInfo): BluebirdPromise<any> {\n  const args = [\"--deep\", \"--force\", \"--sign\", options.cscName, path]\n  if (options.cscKeychainName != null) {\n    args.push(\"--keychain\", options.cscKeychainName)\n  }\n  return exec(\"codesign\", args)\n}\n\nexport function deleteKeychain(keychainName: string, ignoreNotFound: boolean = true): BluebirdPromise<any> {\n  const result = exec(\"security\", [\"delete-keychain\", keychainName])\n  if (ignoreNotFound) {\n    return result.catch(error => {\n      if (!error.message.includes(\"The specified keychain could not be found.\")) {\n        throw error\n      }\n    })\n  }\n  else {\n    return result\n  }\n}\n\nexport function downloadCertificate(cscLink: string): Promise<string> {\n  const certPath = path.join(tmpdir(), randomString() + \".p12\")\n  return download(cscLink, certPath)\n    .thenReturn(certPath)\n}"]}